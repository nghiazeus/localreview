<script src="/../js/loaddata.js" defer></script>
<div class="work-sans leading-normal text-base tracking-normal">
    <!--Nav-->
    <div class="fixed top-0 left-0 w-full shadow z-40">
        <nav id="header" class="w-full z-40 top-0 py-2 bg-white backdrop-blur-lg">
            <div class="mx-auto flex items-center justify-between px-2 relative">
                <!-- Tiêu đề mobile -->
                <div class="md:hidden flex items-center">
                    <a th:href="@{/index}" class="font-bold text-xl">
                        <strong class="text-yellow-400">RE</strong>VIEW
                    </a>
                </div>

                <!-- Tiêu đề laptop -->
                <div class="hidden md:flex md:items-center md:w-auto">
                    <a class="flex items-center tracking-wide no-underline hover:no-underline font-bold text-xl"
                        th:href="@{/index}">
                        <strong class="text-yellow-400">RE</strong>VIEW
                    </a>
                </div>

                <!-- Thanh tìm kiếm destop -->
                <div class="flex-grow mx-2 flex items-center justify-center hidden md:flex relative">
                    <form action="/store/search" method="GET" class="relative flex items-center w-full max-w-2xl">
                        <input name="query" type="text" placeholder="Tìm kiếm..." class="w-full py-3 pl-4 pr-10 text-sm bg-white border border-gray-300 
                            rounded-full shadow-sm dark:bg-neutral-800 dark:border-neutral-600 
                            focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent 
                            transition duration-300 ease-in-out" required autocomplete="off" id="searchInput">

                        <button type="submit" id="searchButton" class="absolute right-0 mr-2 text-blue-500">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                        </button>
                    </form>

                    <!-- Lịch sử tìm kiếm -->
                    <div id="searchHistory" th:if="${not #lists.isEmpty(searchHistory)}"
                        class="absolute inset-x-0 mt-2 max-w-2xl p-4 mx-auto bg-white md:rounded-lg shadow-lg hidden">
                        <ul class="space-y-2">
                            <!-- Gợi ý -->
                            <ul id="suggestionList"></ul>
                            <li th:each="history : ${searchHistory}">
                                <div class="flex justify-between items-center">
                                    <span class="mr-4">
                                        <i class="bi bi-clock-history"></i>
                                    </span>
                                    <button type="button" th:attr="data-term=${history.searchTerm}"
                                        th:text="${history.searchTerm}"
                                        class="block w-full text-left py-2 text-gray-700 hover:text-blue-500 cursor-pointer"
                                        onclick="searchTermClicked(this)">
                                    </button>
                                    <button type="button" th:attr="data-id=${history.historyId}"
                                        class="text-red-500 ml-2" onclick="deleteSearchHistory(this)">
                                        Xóa
                                    </button>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>

                <script>
                    document.addEventListener("DOMContentLoaded", function () {
                        const searchInput = document.getElementById("searchInput");
                        const searchHistory = document.getElementById("searchHistory");
                        const suggestionList = document.getElementById("suggestionList");

                        // Hiển thị lịch sử tìm kiếm khi nhấn vào ô input
                        searchInput.addEventListener("focus", function () {
                            searchHistory.classList.remove("hidden"); // Hiện lịch sử tìm kiếm
                        });

                        // Ẩn lịch sử tìm kiếm và gợi ý khi click ra ngoài
                        document.addEventListener("click", function (event) {
                            if (!searchHistory.contains(event.target) && !searchInput.contains(event.target)) {
                                searchHistory.classList.add("hidden"); // Ẩn lịch sử tìm kiếm
                            }
                        });

                        // Giữ lịch sử tìm kiếm hiển thị nếu nhấn vào
                        searchHistory.addEventListener("click", function (event) {
                            event.stopPropagation(); // Ngăn chặn sự kiện click nổi lên
                        });

                        function deleteSearchHistory(button) {
                            const historyId = button.getAttribute("data-id"); // Lấy ID của lịch sử tìm kiếm
                            const listItem = button.closest('li'); // Lưu lại mục danh sách để xử lý sau

                            fetch(`/search/history/delete?historyId=${historyId}`, {
                                method: 'POST'
                            })
                                .then(response => {
                                    if (response.ok) {
                                        // Xóa mục trong DOM
                                        listItem.remove();

                                        // Kiểm tra xem còn mục nào trong danh sách không
                                        const historyList = document.querySelector('#searchHistory ul');
                                        if (historyList.children.length === 0) {
                                            // Nếu không còn mục nào thì ẩn bảng lịch sử
                                            document.getElementById('searchHistory').classList.add('hidden');
                                        }
                                    }
                                })
                                .catch(error => {
                                    console.error('Error:', error);
                                    // Có thể xử lý lỗi ở đây nếu cần
                                });
                        }

                        // Hiển thị gợi ý tìm kiếm
                        searchInput.addEventListener("input", function () {
                            const query = searchInput.value;

                            if (query.length > 0) {
                                fetch(`/api/store/suggestions?keyword=${query}`)
                                    .then(response => response.json())
                                    .then(suggestions => {
                                        // Xóa các gợi ý cũ
                                        suggestionList.innerHTML = '';

                                        // Sắp xếp gợi ý dựa trên độ dài và độ tương đồng
                                        suggestions.sort((a, b) => {
                                            // Đưa từ khóa giống nhất lên đầu
                                            const aLower = a.toLowerCase();
                                            const bLower = b.toLowerCase();
                                            const queryLower = query.toLowerCase();

                                            const aIndex = aLower.indexOf(queryLower);
                                            const bIndex = bLower.indexOf(queryLower);

                                            // So sánh vị trí xuất hiện của từ khóa trong gợi ý
                                            if (aIndex === bIndex) {
                                                return aLower.length - bLower.length; // Sắp xếp theo độ dài nếu vị trí giống nhau
                                            }
                                            return aIndex - bIndex; // Đưa từ có vị trí xuất hiện trước lên trên
                                        });

                                        if (suggestions.length > 0) {
                                            // Hiển thị các gợi ý
                                            suggestions.forEach(suggestion => {
                                                const li = document.createElement('li');
                                                li.textContent = suggestion;
                                                li.className = "py-2 text-gray-700 hover:text-blue-500 cursor-pointer";
                                                li.onclick = function () {
                                                    searchInput.value = suggestion;  // Gán giá trị vào ô tìm kiếm
                                                    searchHistory.classList.add("hidden");  // Ẩn danh sách gợi ý
                                                    searchInput.form.submit();  // Gửi form
                                                };
                                                suggestionList.appendChild(li);
                                            });
                                            suggestionList.classList.remove("hidden"); // Hiện danh sách gợi ý
                                        } else {
                                            suggestionList.classList.add("hidden"); // Ẩn danh sách gợi ý nếu không có
                                        }
                                    })
                                    .catch(error => {
                                        console.error('Error fetching suggestions:', error);
                                    });
                            } else {
                                suggestionList.classList.add("hidden"); // Ẩn nếu không có ký tự nào
                            }
                        });
                    });

                </script>
                <!-- ====================Script Destop=========================== -->

                <!-- Icon người dùng -->
                <div class="relative inline-block text-left md:mr-4">
                    <!-- Icon bell -->
                    <div class="flex space-x-6 md:space-x-8 items-center">
                        <!-- ================================================ -->
                        <div class="sm:hidden">
                            <!-- Button -->
                            <i id="toggleSearchPanel" class="bi bi-search text-gray-700 text-2xl"></i>
                            <!-- Search Panel -->
                        </div>
                        <div>
                            <a href="/feed" class="bi bi-app-indicator text-2xl text-gray-700 cursor-pointer"></a>
                        </div>

                        <!-- =============================================== -->
                        <a href="#" class="relative hover:text-blue-500">
                            <!-- Số 100 nằm trên icon, nhỏ hơn và không che chuông -->
                            <span
                                class="absolute top-0 right-0 transform translate-x-1/2 -translate-y-1/2 bg-red-500 text-white text-xs font-semibold rounded-full px-0.5 py-0.5">
                                100
                            </span>

                            <!-- Icon bell -->
                            <i class="bi bi-bell text-2xl text-gray-700"></i>
                        </a>
                        <!-- menu -->
                        <div class="flex flex-col items-center mr-0">
                            <i class="bi bi-list text-gray-700 text-4xl md:text-4xl cursor-pointer"
                                id="toggle-menu-btn"></i>
                            <i class="bi bi-x text-gray-700 text-4xl md:text-4xl cursor-pointer hidden"
                                id="close-menu-btn"></i>
                        </div>
                    </div>
                </div>
            </div>
        </nav>
        <h1 th:if="${#request.remoteUser}" class="absolute left-0 top-0 text-xs text-transparent bg-gradient-to-r from-pink-400 to-violet-300
           font-medium text-gray-800 text-left w-34 md:w-auto truncate">
            Hi, <span th:text="${currentUser.name}">User</span>!
        </h1>
        <!-- -----------------Mobile------------- -->
        <div id="searchPanel"
            class="fixed top-0 right-0 w-full h-full bg-white transform translate-x-full transition-transform duration-500 ease-in-out z-50">
            <div class="flex items-center p-4 gap-2 w-full">
                <i id="closeSearchPanel" class="bi bi-chevron-left text-gray-400 text-3xl"></i>
                <form action="/store/search" method="GET" class="relative flex items-center w-full max-w-2xl">
                    <input name="query" type="text" placeholder="Tìm kiếm..." class="w-full py-2 pl-4 pr-10 text-sm bg-white border border-gray-300 
                        rounded-full shadow-sm dark:bg-neutral-800 dark:border-neutral-600 
                        focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent 
                        transition duration-300 ease-in-out" required autocomplete="off" id="searchInput">

                    <button type="submit" id="searchButton" class="absolute right-0 mr-2 text-blue-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </button>
                </form>
            </div>
            <ul class="p-4 space-y-4 ">
                <li th:each="history : ${searchHistory}">
                    <div class="flex justify-between items-center">
                        <span class="mr-4">
                            <i class="bi bi-clock-history"></i>
                        </span>
                        <button type="button" th:attr="data-term=${history.searchTerm}" th:text="${history.searchTerm}"
                            class="block w-full text-left py-2 text-gray-700 hover:text-blue-500 cursor-pointer"
                            onclick="searchTermClicked(this)">
                        </button>
                        <button type="button" th:attr="data-id=${history.historyId}" class="text-red-500 ml-2"
                            onclick="deleteSearchHistory(this)">
                            Xóa
                        </button>
                    </div>
                </li>
            </ul>
        </div>
        <script>
            const toggleSearchPanel = document.getElementById('toggleSearchPanel');
            const closeSearchPanel = document.getElementById('closeSearchPanel');
            const searchPanel = document.getElementById('searchPanel');

            // Mở bảng tìm kiếm
            toggleSearchPanel.addEventListener('click', () => {
                searchPanel.classList.remove('translate-x-full');
            });

            // Đóng bảng tìm kiếm
            closeSearchPanel.addEventListener('click', () => {
                searchPanel.classList.add('translate-x-full');
            });

            function deleteSearchHistory(button) {
                const historyId = button.getAttribute("data-id"); // Lấy ID của lịch sử tìm kiếm
                const listItem = button.closest('li'); // Lưu lại mục danh sách để xử lý sau

                fetch(`/search/history/delete?historyId=${historyId}`, {
                    method: 'POST'
                })
                    .then(response => {
                        if (response.ok) {
                            // Xóa mục trong DOM
                            listItem.remove();

                            // Kiểm tra xem còn mục nào trong danh sách không
                            const historyList = document.querySelector('#searchHistory ul');
                            if (historyList.children.length === 0) {
                                // Nếu không còn mục nào thì ẩn bảng lịch sử
                                document.getElementById('searchHistory').classList.add('hidden');
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        // Có thể xử lý lỗi ở đây nếu cần
                    });
            }



        </script>
        <!-- =============================================== -->
    </div>

    <!-- menucon -->
    <div class="relative ">
        <!-- Menu ẩn/hiện -->
        <div id="side-menu"
            class="fixed top-0 mt-12 right-0 h-full w-2/3 md:w-1/2 max-w-md bg-white p-4 shadow-lg z-30 transform translate-x-full transition-transform duration-300">
            <ul class="mt-2 space-y-2 p-2 gap-4">
                <li>
                    <th:block th:if="${#request.remoteUser}" class="py-1" role="none">
                        <a th:href="@{/profile/user}" class="block px-2 py-4 text-lg md:text-xl text-gray-900">
                            <i class="bi bi-person"></i> Tài khoản
                        </a>

                        <a th:href="@{/feed}" class="block px-2 py-4 text-lg md:text-xl text-gray-900">
                            <i class="bi bi-cursor"></i> Feed
                        </a>

                        <a th:href="@{/register-store}" class="block px-2 py-4 text-lg md:text-xl text-gray-900"
                            role="menuitem" tabindex="-1" id="menu-item-2"><i class="bi bi-house-add"></i>
                            Đăng ký cửa hàng
                        </a>
                        <!--  -->
                        <!-- Đăng xuất -->
                        <a th:href="@{/logout}" class="block px-2 py-4 text-lg md:text-xl text-gray-900" role="menuitem"
                            tabindex="-1" id="menu-item-2"><i class="bi bi-box-arrow-right"></i>
                            Đăng xuất
                        </a>
                    </th:block>
                    <!--  -->
                    <th:block th:unless="${#request.remoteUser}">
                        <a th:href="@{/login}" class="block px-2 py-4 text-lg md:text-xl" role="menuitem" tabindex="-1"
                            id="menu-item-0"><i class="bi bi-box-arrow-in-right"></i>
                            Đăng
                            nhập</a>
                        <a th:href="@{/register}" class="block px-2 py-4 text-lg md:text-xl text-gray-900"
                            role="menuitem" tabindex="-1" id="menu-item-1"><i class="bi bi-person-fill-add"></i>
                            Đăng ký
                        </a>
                        <!-- QR Code -->
                        <!-- <a href="https://nghiazeus.github.io/qrcode/"
                            class="bi bi-qr-code-scan text-2xl cursor-pointer"></a> -->
                    </th:block>
                </li>
            </ul>
        </div>
    </div>
    <script>
        const toggleMenuBtn = document.getElementById('toggle-menu-btn');
        const closeMenuBtn = document.getElementById('close-menu-btn');
        const sideMenu = document.getElementById('side-menu');
        let isSideMenuOpen = false;  // Trạng thái của menu

        // Hàm toggle menu và biểu tượng
        const toggleSideMenu = () => {
            if (isSideMenuOpen) {
                sideMenu.classList.remove('translate-x-0');
                sideMenu.classList.add('translate-x-full');
                toggleMenuBtn.classList.remove('bi-x');
                toggleMenuBtn.classList.add('bi-list');
                isSideMenuOpen = false;
            } else {
                sideMenu.classList.remove('translate-x-full');
                sideMenu.classList.add('translate-x-0');
                toggleMenuBtn.classList.remove('bi-list');
                toggleMenuBtn.classList.add('bi-x');
                isSideMenuOpen = true;
            }
        };

        // Sự kiện click cho nút mở menu
        toggleMenuBtn.addEventListener('click', toggleSideMenu);

        // Sự kiện click cho dấu X để đóng menu
        closeMenuBtn.addEventListener('click', toggleSideMenu);

    </script>
</div>

<!-- Mobile Bottom Navigation -->
<nav id="menumobile"
    class="fixed inset-x-0 bottom-0 backdrop-blur-lg backdrop-filter backdrop-blur-xl border-gray-200 shadow-lg z-40 md:hidden">
    <div class="flex justify-around items-center py-2">
        <!-- Home Icon -->
        <a href="/index" class="menu-item flex flex-col items-center text-gray-600 hover:text-black"
            data-active-path="/index">
            <i class="bi bi-house text-2xl"></i>
            <span class="text-xs">Trang chủ</span>
        </a>
        <!-- Store Icon -->
        <a href="/store" class="menu-item flex flex-col items-center text-gray-600 hover:text-black"
            data-active-path="/store">
            <i class="bi bi-shop-window text-2xl"></i>
            <span class="text-xs">Cửa hàng</span>
        </a>
        <!-- Categories Icon -->
        <a href="/categories" class="menu-item flex flex-col items-center text-gray-600 hover:text-black"
            data-active-path="/categories">
            <i class="bi bi-bookmarks text-2xl"></i>
            <span class="text-xs">Loại</span>
        </a>
        <!-- QR Code Icon -->
        <a href="https://nghiazeus.github.io/qrcodemobile/"
            class="menu-item flex flex-col items-center text-gray-600 hover:text-black"
            data-active-path="https://nghiazeus.github.io/qrcodemobile/">
            <i class="bi bi-qr-code-scan text-2xl"></i>
            <span class="text-xs">QR Code</span>
        </a>
        <!-- Filter Icon -->
        <a id="openModalFilter"
            class="menu-item flex flex-col cursor-pointer items-center text-gray-600 hover:text-black">
            <i class="bi bi-funnel text-2xl"></i>
            <span class="text-xs">Lọc</span>
        </a>
        <!-- Profile Icon -->
        <th:block th:if="${#request.remoteUser}">
            <a th:href="@{/profile/user}" class="menu-item flex flex-col items-center text-gray-600 hover:text-black">
                <i class="bi bi-person text-2xl"></i>
                <span class="text-xs">Tài khoản</span>
            </a>
        </th:block>
    </div>
</nav>

<div id="filterModal"
    class="fixed top-0 left-0 h-full w-full bg-white shadow-lg transform -translate-x-full transition-transform duration-300 z-20">
    <div class="p-4">
        <!-- Your filter content goes here -->
        <button id="closeModalFilter" class="bg-gray-100 text-black px-2 py-1 rounded-full mb-2 mt-14">
            <i class="bi bi-x-lg text-xl"></i>
        </button>

        <!-- Sort by Views -->
        <div class="mb-4 mt-10">
            <label class="block text-gray-800 font-medium mb-2 text-lg text-left">Lọc theo lượt xem:</label>
            <div class="relative">
                <select
                    class="w-full bg-gray-100 rounded-xl p-4 pr-10 shadow-md text-gray-700 text-lg focus:outline-none appearance-none">
                    <option>Mặc định</option>
                    <option>Nhiều lượt xem nhất</option>
                    <option>Ít lượt xem nhất</option>
                </select>
                <span class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 pointer-events-none">
                    <i class="bi bi-chevron-down text-xl"></i>
                </span>
            </div>
        </div>

        <!-- Sort by Rating -->
        <div class="mb-6">
            <label class="block text-gray-800 font-medium mb-2 text-lg text-left">Lọc theo đánh giá:</label>
            <div class="relative">
                <select
                    class="w-full bg-gray-100 rounded-xl p-4 pr-10 shadow-md text-gray-700 text-lg focus:outline-none appearance-none">
                    <option>Mặc định</option>
                    <option>Cao nhất</option>
                    <option>Thấp nhất</option>
                </select>
                <span class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 pointer-events-none">
                    <i class="bi bi-chevron-down text-xl"></i>
                </span>
            </div>
        </div>

        <!-- Filter by Type -->
        <div class="mb-6">
            <label class="block text-gray-800 font-medium mb-2 text-lg text-left">Loại cửa hàng:</label>
            <div class="relative">
                <select
                    class="w-full bg-gray-100 rounded-xl p-4 pr-10 shadow-md text-gray-700 text-lg focus:outline-none appearance-none">
                    <option>Tất cả</option>
                </select>
                <span class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 pointer-events-none">
                    <i class="bi bi-chevron-down text-xl"></i>
                </span>
            </div>
        </div>

        <!-- Apply Filters Button -->
        <button
            class="w-full bg-pink-400 text-white font-semibold py-4 rounded-xl shadow-lg transition duration-300 text-lg">
            Áp dụng bộ lọc
        </button>
    </div>
</div>

<script>
    document.getElementById('openModalFilter').addEventListener('click', function () {
        document.getElementById('filterModal').classList.remove('-translate-x-full');
    });

    document.getElementById('closeModalFilter').addEventListener('click', function () {
        document.getElementById('filterModal').classList.add('-translate-x-full');
    });

</script>