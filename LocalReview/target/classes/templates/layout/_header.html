<script src="/../js/loaddata.js" defer></script>
<div class="work-sans leading-normal text-base tracking-normal">
    <!--Nav-->
    <div class="fixed top-0 left-0 w-full shadow z-40">
        <nav id="header" class="w-full z-40 top-0 py-2 bg-white backdrop-blur-lgflex items-center justify-between">
            <div class="flex-grow mx-2 flex items-center relative justify-between relative">
                <!-- Tiêu đề mobile -->
                <div class="md:hidden flex items-center">
                    <a th:href="@{/index}" class="font-bold text-xl">
                        <strong class="text-yellow-400">RE</strong>VIEW
                    </a>
                </div>

                <!-- Tiêu đề laptop -->
                <div class="hidden md:flex md:items-center md:w-auto">
                    <a class="flex items-center tracking-wide no-underline hover:no-underline font-bold text-xl"
                        th:href="@{/index}">
                        <strong class="text-yellow-400">RE</strong>VIEW
                    </a>
                </div>

                <!-- Thanh tìm kiếm destop -->

                <div class="flex-grow mx-2 flex flex-col items-center justify-center hidden md:flex relative">
                    <form action="/store/search" method="GET" class="relative flex items-center w-full max-w-2xl">
                        <input name="query" type="text" placeholder="Tìm kiếm..." class="w-full py-3 pl-4 pr-10 text-sm border rounded-full shadow-sm  
                               focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent 
                               transition duration-300 ease-in-out" required autocomplete="off" id="searchInput">

                        <button type="submit" id="searchButton" class="absolute right-0 mr-2 text-blue-500">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                        </button>
                    </form>

                    <!-- Lịch sử tìm kiếm -->
                    <div id="searchHistory"
                        class="absolute w-full top-16 max-w-2xl p-4 mx-auto bg-white md:rounded-lg shadow-lg hidden">
                        <ul class="space-y-2 max-h-96 overflow-auto scroll-smooth snap-mandatory">
                            <!-- Gợi ý -->
                            <li id="suggestionList"></li>
                            <li th:each="history : ${searchHistory}" class="hover:bg-gray-100 rounded-full">
                                <div class="flex justify-between items-center px-4">
                                    <span class="mr-4">
                                        <i class="bi bi-clock-history"></i>
                                    </span>
                                    <button type="button" th:attr="data-term=${history.searchTerm}"
                                        th:text="${history.searchTerm}"
                                        class="block w-full text-left py-2 text-gray-700 cursor-pointer"
                                        onclick="searchTermClicked(this)">
                                    </button>
                                    <button type="button" th:attr="data-id=${history.historyId}"
                                        class="text-red-500 ml-2 hover:underline" onclick="deleteSearchHistory(this)">
                                        xóa
                                    </button>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>

                <script>
                document.addEventListener("DOMContentLoaded", function () {
                    const searchInput = document.getElementById("searchInput");
                    const suggestionList = document.getElementById("suggestionList");
                    const searchHistoryContainer = document.getElementById("searchHistory");
                    let debounceTimer;

                    // Function to handle search term click
                    window.searchTermClicked = function (element) {
                        const term = element.getAttribute('data-term');
                        searchInput.value = term;  // Set the search input value
                        document.getElementById("searchButton").click();  // Trigger the search form submission
                    };

                    // Function to delete search history
                    window.deleteSearchHistory = function (element) {
                        const historyId = element.getAttribute('data-id');

                        fetch('/search/history/delete', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                            },
                            body: new URLSearchParams({ historyId })
                        })
                            .then(response => {
                                if (response.ok) {
                                    // Remove the history item from the DOM
                                    element.parentElement.parentElement.remove();
                                }
                            })
                            .catch(error => console.error('Error deleting search history:', error));
                    };

                    // Show search history or suggestions when the input is focused
                    searchInput.addEventListener('focus', function () {
                        // Check if there's any search history or suggestion
                        const hasHistory = searchHistoryContainer.querySelector('li:not(#suggestionList)');
                        if (hasHistory) {
                            searchHistoryContainer.classList.remove('hidden');
                        }
                    });

                    // Fetch store suggestions while typing
                    searchInput.addEventListener('input', function () {
                        const keyword = this.value.trim();

                        // Clear previous suggestions if input is empty
                        if (!keyword) {
                            suggestionList.innerHTML = "";
                            searchHistoryContainer.classList.add('hidden'); // Hide the suggestion list
                            return;
                        }

                        // Debounce to avoid too many API calls
                        clearTimeout(debounceTimer);
                        debounceTimer = setTimeout(() => {
                            fetch(`/api/store/suggestions?keyword=${encodeURIComponent(keyword)}`)
                                .then(response => response.json())
                                .then(suggestions => {
                                    suggestionList.innerHTML = "";  // Clear previous suggestions

                                    if (suggestions.length > 0) {
                                        suggestions.forEach(suggestion => {
                                            // Create the list item for suggestion
                                            const suggestionItem = document.createElement('li');
                                            suggestionItem.className = "cursor-pointer flex items-center py-2 px-4 rounded-full hover:bg-gray-100";

                                            // Create the icon (kính lúp)
                                            const icon = document.createElement('span');
                                            icon.className = "text-black mr-4";
                                            icon.innerHTML = `<i class="bi bi-search"></i>`;

                                            // Create the text for suggestion
                                            const suggestionText = document.createElement('span');
                                            suggestionText.textContent = suggestion;

                                            // Set click event for the suggestion item
                                            suggestionItem.onclick = function () {
                                                searchInput.value = suggestion;  // Set input to selected suggestion
                                                document.getElementById("searchButton").click();  // Submit search form
                                            };

                                            // Append icon and text to the suggestion item
                                            suggestionItem.appendChild(icon);
                                            suggestionItem.appendChild(suggestionText);

                                            // Append the suggestion item to the suggestion list
                                            suggestionList.appendChild(suggestionItem);
                                        });

                                        // Show suggestion list if suggestions exist
                                        searchHistoryContainer.classList.remove('hidden');
                                    } else {
                                        suggestionList.innerHTML = "";  // Clear the list
                                        searchHistoryContainer.classList.add('hidden'); // Hide the suggestion list if no results
                                    }
                                })
                                .catch(error => console.error('Error fetching suggestions:', error));
                        }, 300);  // Debounce delay of 300ms
                    });

                    // Hide search history and suggestion list if clicked outside
                    document.addEventListener('click', function (event) {
                        if (!searchInput.contains(event.target) && !searchHistoryContainer.contains(event.target)) {
                            searchHistoryContainer.classList.add('hidden');
                        }
                    });
                });

                </script>


                <!-- ====================Script Destop=========================== -->

                <!-- Icon người dùng -->
                <div class="relative inline-block text-left md:mr-4">
                    <!-- Icon bell -->
                    <div class="flex space-x-6 md:space-x-8 items-center">
                        <!-- ================================================ -->
                        <div class="sm:hidden">
                            <!-- Button -->
                            <i id="openSearchPanel" class="bi bi-search text-gray-700 text-2xl"></i>
                            <!-- Search Panel -->
                        </div>
                        <div>
                            <a href="/feed" class="bi bi-app-indicator text-2xl text-gray-700 cursor-pointer"></a>
                        </div>

                        <!-- =============================================== -->
                        <a href="#" class="relative hover:text-blue-500">
                            <!-- Số 100 nằm trên icon, nhỏ hơn và không che chuông -->
                            <span
                                class="absolute top-0 right-0 transform translate-x-1/2 -translate-y-1/2 bg-red-500 text-white text-xs font-semibold rounded-full px-0.5 py-0.5">
                                100
                            </span>

                            <!-- Icon bell -->
                            <i class="bi bi-bell text-2xl text-gray-700"></i>
                        </a>
                        <!-- menu -->
                        <div class="flex flex-col items-center mr-0">
                            <i class="bi bi-list text-gray-700 text-4xl md:text-4xl cursor-pointer"
                                id="toggle-menu-btn"></i>
                            <i class="bi bi-x text-gray-700 text-4xl md:text-4xl cursor-pointer hidden"
                                id="close-menu-btn"></i>
                        </div>
                    </div>
                </div>
            </div>
        </nav>
        <h1 th:if="${#request.remoteUser}" class="absolute left-0 top-0 text-xs text-transparent bg-gradient-to-r from-pink-400 to-violet-300
           font-medium text-gray-800 text-left w-34 md:w-auto truncate">
            Hi, <span th:text="${currentUser.name}">User</span>!
        </h1>
        <!-- -----------------Mobile------------- -->
        <div id="searchPanel"
            class="fixed top-0 right-0 w-full h-full bg-white transform translate-x-full transition-transform duration-500 ease-in-out z-40">

            <!-- Thanh tìm kiếm và nút đóng luôn cố định -->
            <div class="flex items-center p-4 gap-2 w-full bg-white z-50 sticky top-0">
                <i id="closeSearchPanel" class="bi bi-chevron-left text-gray-400 font-bold text-3xl"></i>
                <form action="/store/search" method="GET" class="relative flex items-center w-full max-w-2xl">
                    <input name="query" type="text" placeholder="Tìm kiếm..." class="w-full py-2 pl-4 pr-10 text-sm text-lime-500 border 
                    rounded-full shadow-sm  
                     focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent 
                      transition duration-300 ease-in-out" required autocomplete="off" id="mobileSearchInput">

                    <button type="submit" id="mobileSearchButton" class="absolute right-0 mr-2 text-blue-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </button>
                </form>
            </div>

            <!-- Phần nội dung gợi ý và lịch sử tìm kiếm có thể cuộn -->
            <ul class="space-y-4 px-6 overflow-auto h-screen">
                <!-- Gợi ý tìm kiếm -->
                <ul id="mobileSuggestionList"></ul>
                <!-- Lịch sử tìm kiếm -->
                <li th:each="history : ${searchHistory}">
                    <div class="flex justify-between items-center">
                        <span class="mr-4">
                            <i class="bi bi-clock-history text-black text-lg"></i>
                        </span>
                        <button type="button" th:attr="data-term=${history.searchTerm}" th:text="${history.searchTerm}"
                            class="block w-full text-left py-2 text-gray-700 hover:text-blue-500 cursor-pointer"
                            onclick="searchTermClicked(this)">
                        </button>
                        <button type="button" th:attr="data-id=${history.historyId}" class="text-red-500 ml-2"
                            onclick="deleteSearchHistory(this)">
                            Xóa
                        </button>   
                    </div>
                </li>
            </ul>
        </div>

        <script>
            document.addEventListener("DOMContentLoaded", function () {
                const searchPanel = document.getElementById('searchPanel');
                const closeSearchPanel = document.getElementById('closeSearchPanel');
                const openSearchPanel = document.getElementById('openSearchPanel');
                const mobileSearchInput = document.getElementById('mobileSearchInput');
                const mobileSuggestionList = document.getElementById('mobileSuggestionList');
                const searchButton = document.getElementById("mobileSearchButton");
                let debounceTimer;

                // Mở panel tìm kiếm (cho mobile)
                if (openSearchPanel) {
                    openSearchPanel.addEventListener('click', function () {
                        searchPanel.classList.remove('translate-x-full');  // Hiển thị panel tìm kiếm trên mobile
                    });
                }

                // Đóng panel tìm kiếm (cho mobile)
                if (closeSearchPanel) {
                    closeSearchPanel.addEventListener('click', function () {
                        searchPanel.classList.add('translate-x-full');  // Ẩn panel tìm kiếm trên mobile
                        mobileSuggestionList.innerHTML = "";  // Xóa gợi ý khi đóng panel
                    });
                }

                // Lấy gợi ý khi nhập từ khóa (cho mobile)
                if (mobileSearchInput) {
                    mobileSearchInput.addEventListener('input', function () {
                        const keyword = this.value.trim();

                        // Xóa gợi ý trước đó nếu ô tìm kiếm rỗng
                        if (!keyword) {
                            mobileSuggestionList.innerHTML = "";
                            return;
                        }

                        // Debounce để tránh gọi API quá nhiều
                        clearTimeout(debounceTimer);
                        debounceTimer = setTimeout(() => {
                            fetch(`/api/store/suggestions?keyword=${encodeURIComponent(keyword)}`)
                                .then(response => response.json())
                                .then(suggestions => {
                                    mobileSuggestionList.innerHTML = "";  // Xóa gợi ý trước đó

                                    if (suggestions.length > 0) {
                                        suggestions.forEach(suggestion => {
                                            const suggestionItem = document.createElement('li');
                                            suggestionItem.className = "cursor-pointer flex items-center py-4";

                                            // Thêm biểu tượng kính lúp vào gợi ý
                                            const icon = document.createElement('span');
                                            icon.className = "text-black mr-4";
                                            icon.innerHTML = '<i class="bi bi-search text-lg"></i>';

                                            const suggestionText = document.createElement('span');
                                            suggestionText.textContent = suggestion;

                                            // Thêm sự kiện khi nhấn vào gợi ý
                                            suggestionItem.onclick = function () {
                                                mobileSearchInput.value = suggestion;  // Đặt ô tìm kiếm bằng gợi ý đã chọn
                                                searchButton.click();  // Gửi form tìm kiếm
                                            };

                                            // Gắn icon và text vào mục gợi ý
                                            suggestionItem.appendChild(icon);
                                            suggestionItem.appendChild(suggestionText);

                                            // Thêm mục gợi ý vào danh sách
                                            mobileSuggestionList.appendChild(suggestionItem);
                                        });
                                    } else {
                                        const noResultItem = document.createElement('li');
                                        noResultItem.className = "py-2 px-4 text-gray-500";
                                        noResultItem.textContent = "Không có cửa hàng";
                                        mobileSuggestionList.appendChild(noResultItem);
                                    }
                                })
                                .catch(error => console.error('Lỗi khi lấy gợi ý:', error));
                        }, 300);  // Thời gian debounce 300ms
                    });
                }
            });

        </script>

        <!-- =============================================== -->
    </div>

    <!-- menucon -->
    <div class="relative ">
        <!-- Menu ẩn/hiện -->
        <div id="side-menu"
            class="fixed top-0 mt-12 right-0 h-full w-2/3 md:w-1/2 max-w-md bg-white p-4 shadow-lg z-30 transform translate-x-full transition-transform duration-300">
            <ul class="mt-2 space-y-2 p-2 gap-4">
                <li>
                    <th:block th:if="${#request.remoteUser}" class="py-1" role="none">
                        <a th:href="@{/profile/user}" class="block px-2 py-4 text-lg md:text-xl text-gray-900">
                            <i class="bi bi-person"></i> Tài khoản
                        </a>

                        <a th:href="@{/feed}" class="block px-2 py-4 text-lg md:text-xl text-gray-900">
                            <i class="bi bi-cursor"></i> Feed
                        </a>

                        <a th:href="@{/register-store}" class="block px-2 py-4 text-lg md:text-xl text-gray-900"
                            role="menuitem" tabindex="-1" id="menu-item-2"><i class="bi bi-house-add"></i>
                            Đăng ký cửa hàng
                        </a>
                        <!--  -->
                        <!-- Đăng xuất -->
                        <a th:href="@{/logout}" class="block px-2 py-4 text-lg md:text-xl text-gray-900" role="menuitem"
                            tabindex="-1" id="menu-item-2"><i class="bi bi-box-arrow-right"></i>
                            Đăng xuất
                        </a>
                    </th:block>
                    <!--  -->
                    <th:block th:unless="${#request.remoteUser}">
                        <a th:href="@{/login}" class="block px-2 py-4 text-lg md:text-xl" role="menuitem" tabindex="-1"
                            id="menu-item-0"><i class="bi bi-box-arrow-in-right"></i>
                            Đăng
                            nhập</a>
                        <a th:href="@{/register}" class="block px-2 py-4 text-lg md:text-xl text-gray-900"
                            role="menuitem" tabindex="-1" id="menu-item-1"><i class="bi bi-person-fill-add"></i>
                            Đăng ký
                        </a>
                        <!-- QR Code -->
                        <!-- <a href="https://nghiazeus.github.io/qrcode/"
                            class="bi bi-qr-code-scan text-2xl cursor-pointer"></a> -->
                    </th:block>
                </li>
            </ul>
        </div>
    </div>
    <script>
        const toggleMenuBtn = document.getElementById('toggle-menu-btn');
        const closeMenuBtn = document.getElementById('close-menu-btn');
        const sideMenu = document.getElementById('side-menu');
        let isSideMenuOpen = false;  // Trạng thái của menu

        // Hàm toggle menu và biểu tượng
        const toggleSideMenu = () => {
            if (isSideMenuOpen) {
                sideMenu.classList.remove('translate-x-0');
                sideMenu.classList.add('translate-x-full');
                toggleMenuBtn.classList.remove('bi-x');
                toggleMenuBtn.classList.add('bi-list');
                isSideMenuOpen = false;
            } else {
                sideMenu.classList.remove('translate-x-full');
                sideMenu.classList.add('translate-x-0');
                toggleMenuBtn.classList.remove('bi-list');
                toggleMenuBtn.classList.add('bi-x');
                isSideMenuOpen = true;
            }
        };

        // Sự kiện click cho nút mở menu
        toggleMenuBtn.addEventListener('click', toggleSideMenu);

        // Sự kiện click cho dấu X để đóng menu
        closeMenuBtn.addEventListener('click', toggleSideMenu);

    </script>
</div>

<!-- Mobile Bottom Navigation -->
<nav id="menumobile"
    class="fixed inset-x-0 bottom-0 backdrop-blur-lg backdrop-filter backdrop-blur-xl border-gray-200 shadow-lg z-30 md:hidden">
    <div class="flex justify-around items-center py-2">
        <!-- Home Icon -->
        <a href="/index" class="menu-item flex flex-col items-center text-gray-600 hover:text-black"
            data-active-path="/index">
            <i class="bi bi-house text-2xl"></i>
            <span class="text-xs">Trang chủ</span>
        </a>
        <!-- Store Icon -->
        <a href="/store" class="menu-item flex flex-col items-center text-gray-600 hover:text-black"
            data-active-path="/store">
            <i class="bi bi-shop-window text-2xl"></i>
            <span class="text-xs">Cửa hàng</span>
        </a>
        <!-- Categories Icon -->
        <a href="/categories" class="menu-item flex flex-col items-center text-gray-600 hover:text-black"
            data-active-path="/categories">
            <i class="bi bi-bookmarks text-2xl"></i>
            <span class="text-xs">Loại</span>
        </a>
        <!-- QR Code Icon -->
        <a href="https://nghiazeus.github.io/qrcodemobile/"
            class="menu-item flex flex-col items-center text-gray-600 hover:text-black"
            data-active-path="https://nghiazeus.github.io/qrcodemobile/">
            <i class="bi bi-qr-code-scan text-2xl"></i>
            <span class="text-xs">QR Code</span>
        </a>
        <!-- Filter Icon -->
        <a id="openModalFilter"
            class="menu-item flex flex-col cursor-pointer items-center text-gray-600 hover:text-black">
            <i class="bi bi-funnel text-2xl"></i>
            <span class="text-xs">Lọc</span>
        </a>
        <!-- Profile Icon -->
        <th:block th:if="${#request.remoteUser}">
            <a th:href="@{/profile/user}" class="menu-item flex flex-col items-center text-gray-600 hover:text-black">
                <i class="bi bi-person text-2xl"></i>
                <span class="text-xs">Tài khoản</span>
            </a>
        </th:block>
    </div>
</nav>

<div id="filterModal"
    class="fixed top-0 left-0 h-full w-full bg-white shadow-lg transform -translate-x-full transition-transform duration-300 z-20">
    <div class="p-4">
        <!-- Your filter content goes here -->
        <button id="closeModalFilter" class="bg-gray-100 text-black px-2 py-1 rounded-full mb-2 mt-14">
            <i class="bi bi-x-lg text-xl"></i>
        </button>

        <!-- Sort by Views -->
        <div class="mb-4 mt-10">
            <label class="block text-gray-800 font-medium mb-2 text-lg text-left">Lọc theo lượt xem:</label>
            <div class="relative">
                <select
                    class="w-full bg-gray-100 rounded-xl p-4 pr-10 shadow-md text-gray-700 text-lg focus:outline-none appearance-none">
                    <option>Mặc định</option>
                    <option>Nhiều lượt xem nhất</option>
                    <option>Ít lượt xem nhất</option>
                </select>
                <span class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 pointer-events-none">
                    <i class="bi bi-chevron-down text-xl"></i>
                </span>
            </div>
        </div>

        <!-- Sort by Rating -->
        <div class="mb-6">
            <label class="block text-gray-800 font-medium mb-2 text-lg text-left">Lọc theo đánh giá:</label>
            <div class="relative">
                <select
                    class="w-full bg-gray-100 rounded-xl p-4 pr-10 shadow-md text-gray-700 text-lg focus:outline-none appearance-none">
                    <option>Mặc định</option>
                    <option>Cao nhất</option>
                    <option>Thấp nhất</option>
                </select>
                <span class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 pointer-events-none">
                    <i class="bi bi-chevron-down text-xl"></i>
                </span>
            </div>
        </div>

        <!-- Filter by Type -->
        <div class="mb-6">
            <label class="block text-gray-800 font-medium mb-2 text-lg text-left">Loại cửa hàng:</label>
            <div class="relative">
                <select
                    class="w-full bg-gray-100 rounded-xl p-4 pr-10 shadow-md text-gray-700 text-lg focus:outline-none appearance-none">
                    <option>Tất cả</option>
                </select>
                <span class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 pointer-events-none">
                    <i class="bi bi-chevron-down text-xl"></i>
                </span>
            </div>
        </div>

        <!-- Apply Filters Button -->
        <button
            class="w-full bg-pink-400 text-white font-semibold py-4 rounded-xl shadow-lg transition duration-300 text-lg">
            Áp dụng bộ lọc
        </button>
    </div>
</div>

<script>
    document.getElementById('openModalFilter').addEventListener('click', function () {
        document.getElementById('filterModal').classList.remove('-translate-x-full');
    });

    document.getElementById('closeModalFilter').addEventListener('click', function () {
        document.getElementById('filterModal').classList.add('-translate-x-full');
    });

</script>